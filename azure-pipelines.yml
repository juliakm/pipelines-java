# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    mavenOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.8'
    jdkArchitectureOption: 'x64'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    goals: 'package'

- task: CopyFiles@2
  displayName: Copy Files
  inputs:
    SourceFolder: $(system.defaultworkingdirectory)
    Contents: '**'
    TargetFolder: $(build.artifactstagingdirectory)   

- task: PublishBuildArtifacts@1
  displayName: Publish Artifact
  inputs:
    PathtoPublish: $(build.artifactstagingdirectory)    


- task: PackerBuild@1
  displayName: 'Build immutable image'
  inputs:
    templateType: 'builtin'
    ConnectedServiceName: 'DevOps Pipelines - ARM Horizontal Work(82c135d4-f813-4bec-a93e-60e4323918ee)'
    isManagedImage: true
    managedImageName: 'vmss-packer-build'
    location: 'eastus2'
    storageAccountName: 'vmssstorage1234'
    azureResourceGroup: 'java-vmss'
    baseImageSource: 'default'
    baseImage: 'Canonical:UbuntuServer:16.04-LTS:linux'
    packagePath: '$(build.artifactstagingdirectory)'
    deployScriptPath: 'install.sh'